const SB_URL = 'https://jfvpauofczfliqjpupfp.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmdnBhdW9mY3pmbGlxanB1cGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NjQ2MTYsImV4cCI6MjA4NDM0MDYxNn0.1CrMZ4YtxOoAjvEgMg8ffQdl7xldmDkKAFLnukaO6nE';
    const db = supabase.createClient(SB_URL, SB_KEY);

    let user = null;

    async function start() {
        const { data } = await db.auth.getSession();
        user = data.session?.user || null;
        tab('feed', document.querySelector('.nav-btn'));
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
    async function uploadPhoto() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            msg('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–∞...');
            const fileName = `${Date.now()}_${user.id}.jpg`;
            
            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Storage (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∫–µ—Ç 'photos' —Å–æ–∑–¥–∞–Ω –∏ –ø—É–±–ª–∏—á–µ–Ω)
            const { data: uploadData, error: uploadError } = await db.storage
                .from('photos')
                .upload(fileName, file);

            if (uploadError) return msg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + uploadError.message);

            const imgUrl = `${SB_URL}/storage/v1/object/public/photos/${fileName}`;

            // 2. –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É posts
            const { error: dbError } = await db.from('posts').insert([
                { image_url: imgUrl, author: user.email.split('@')[0], user_id: user.id }
            ]);

            if (dbError) return msg('–û—à–∏–±–∫–∞ –ë–î: ' + dbError.message);
            
            msg('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø—Ä–∞–π–¥!');
            tab('feed', document.querySelector('.nav-btn'));
        };
        fileInput.click();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    async function handleAuth(type) {
        const email = prompt('Email:');
        const password = prompt('–ü–∞—Ä–æ–ª—å:');
        if (!email || !password) return;

        msg('–ú–∏–Ω—É—Ç–∫—É...');
        const { data, error } = (type === 'login') 
            ? await db.auth.signInWithPassword({ email, password })
            : await db.auth.signUp({ email, password });

        if (error) return msg(error.message);
        location.reload();
    }

    const views = {
        feed: async () => {
            const { data } = await db.from('posts').select('*').order('created_at', { ascending: false });
            let posts = data || [];
            let html = `
                <div class="promo">
                    <h2>KITTY.AM</h2>
                    <p style="font-size:14px; color:var(--gold); font-weight:bold;">’ñ’∏’ø’∏’∑’∏÷Ç’û’©, ’°’∫’° ’∑’°’ø ’∑’∏÷Ç’ø</p>
                    <button class="btn-gold" onclick="msg('–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å!')">–ó–ê–ü–ò–°–ê–¢–¨–°–Ø</button>
                </div>
            `;
            html += posts.map(p => `
                <div class="card">
                    <img src="${p.image_url}" loading="lazy">
                    <div class="card-footer">
                        <span style="color:var(--gold); font-weight:bold;">üêæ ${p.likes || 0}</span>
                        <span style="color:#555; font-size:11px;">@${p.author || 'kitty'}</span>
                    </div>
                </div>
            `).join('');
            return html;
        },
        profile: () => {
            if (!user) {
                return `
                    <div style="padding:40px 20px; text-align:center;">
                        <h3 style="color:var(--gold);">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–∞–π–¥</h3>
                        <p style="color:#888; margin-bottom:20px;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –æ–±—Ä–∞–∑–∞–º–∏</p>
                        <button class="btn-gold" onclick="handleAuth('login')" style="margin-bottom:10px;">–í–•–û–î</button>
                        <button class="btn-gold" style="background:transparent; border:1px solid var(--gold); color:var(--gold);" onclick="handleAuth('signup')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
                    </div>
                `;
            }
            return `
                <div style="padding:20px; text-align:center;">
                    <div style="width:80px; height:80px; background:#222; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; border:1px solid var(--gold); font-size:30px;">üê±</div>
                    <h3 style="margin-bottom:5px;">${user.email}</h3>
                    <p style="color:#555; font-size:12px; margin-bottom:20px;">–¢–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω</p>
                    <button class="btn-gold" onclick="uploadPhoto()">+ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –§–û–¢–û</button>
                </div>
            `;
        },
        settings: () => `
            <div style="padding:20px;">
                <p style="color:#555; font-size:12px; margin-bottom:10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
                <button class="btn-gold" style="background:#222; color:white; margin-bottom:10px;" onclick="msg('–í–µ—Ä—Å–∏—è 5.1.0')">–û –ü–†–ò–õ–û–ñ–ï–ù–ò–ò</button>
                <button class="btn-gold" style="background:#441111; color:white;" onclick="db.auth.signOut().then(()=>location.reload())">–í–´–ô–¢–ò</button>
            </div>
        `
    };

    async function tab(name, el) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        const container = document.getElementById('main');
        container.innerHTML = '<div style="text-align:center; padding-top:50px; color:var(--gold);">–ú—É—Ä–ª—ã—á–µ–º...</div>';
        container.innerHTML = await views[name]();
    }

    function msg(t) {
        const s = document.getElementById('toast');
        s.innerText = t; s.style.display = 'block';
        setTimeout(() => s.style.display = 'none', 3000);
    }

    start();